# Preparation
# The tests of the CLI makes it necessary to create develop--user installations.
# 1) clean possible remnants of previous develop--user installations
# 2) clone and build Cadishi, requires deploy-key
# 3) build Capriqorn
setup:
  script:
    - export BASE=`pwd`
    - rm -f ~/.local/lib/python2.7/site-packages/cadishi.egg-link
    - rm -f ~/.local/lib/python2.7/site-packages/capriqorn.egg-link
    - git clone git@gitlab.mpcdf.mpg.de:MPIBP-Hummer/Cadishi.git
    - cd Cadishi
    - export CAD_CUDA=0
    - python setup.py develop --user
    - cd $BASE
    - python setup.py develop --user

# Run the included unit test cases
unit_tests:
  script:
    - py.test capriqorn

# Call the Capriqorn CLI by running the trivial included test case
cli_tests:
  script:
    - mkdir tmp
    - cd tmp
    - capriq --help
    - capriq --version
    - capriq example
    - capriq preproc
    - capriq histo
    - capriq postproc
    - cd postprocessor_output
    - capriq unpack postprocessor.h5
    - capriq merge --output foo.h5 postprocessor.h5
    - cd $BASE

# Test the tarball creation.
dist_tests:
  script:
    - python setup.py sdist --formats=gztar

# Clean up remnants.
cleanup:
  script:
    - python setup.py develop --user --uninstall
    - rm -f ~/.local/lib/python2.7/site-packages/cadishi.egg-link
    - rm -f ~/.local/lib/python2.7/site-packages/capriqorn.egg-link
